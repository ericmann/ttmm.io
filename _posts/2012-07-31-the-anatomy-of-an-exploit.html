---
layout: post
title: The Anatomy of an Exploit
date: 2012-07-31 09:00:45.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- JavaScript
- Tutorials
tags:
- security
- WordPress
meta:
  yourls_shorturl: http://eam.me/i0
  _oembed_d785d5d2335a639186403d6d3a1db962: <blockquote class="twitter-tweet" data-width="500"><p
    lang="en" dir="ltr"><a href="https://twitter.com/bluelimemedia">@bluelimemedia</a>
    <a href="https://twitter.com/norcross">@norcross</a> <a href="https://twitter.com/sabreuse">@sabreuse</a>
    <a href="https://twitter.com/EricMann">@EricMann</a> Here is the Malware entry
    for it - <a href="http://t.co/NBljkZHE">http://t.co/NBljkZHE</a></p>&mdash; Sucuri
    (@sucurisecurity) <a href="https://twitter.com/sucurisecurity/status/227884824885608451">July
    24, 2012</a></blockquote><script async src="//platform.twitter.com/widgets.js"
    charset="utf-8"></script>
  _oembed_time_d785d5d2335a639186403d6d3a1db962: '1496517840'
  _wpcom_is_markdown: '1'
  _oembed_48794e64046ac1e07e8570a85538fd72: <blockquote class="twitter-tweet" data-in-reply-to="227882798978048000"
    width="550" lang="fr"><p><a href="https://twitter.com/bluelimemedia"><s>@</s><b>bluelimemedia</b></a>
    <a href="https://twitter.com/norcross"><s>@</s><b>norcross</b></a> <a href="https://twitter.com/sabreuse"><s>@</s><b>sabreuse</b></a>
    <a href="https://twitter.com/ericmann"><s>@</s><b>ericmann</b></a> Here is the
    Malware entry for it - <a href="http://t.co/NBljkZHE" title="http://sucuri.net/malware/malware-entry-mwjs69693">sucuri.net/malware/malwar…</a></p>&mdash;
    Sucuri (@sucuri_security) <a href="https://twitter.com/sucuri_security/status/227884824885608451"
    data-datetime="2012-07-24T21:55:50+00:00">Juillet 24, 2012</a></blockquote><script
    src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  _edit_last: '2'
  _yoast_wpseo_focuskw: exploit
  _yoast_wpseo_metadesc: I saw a new WordPress exploit last week. Luckily, it's both
    easy to fix and prevent. Here are a few tips you can follow on your own site.
  _oembed_e5b0c27d606df3f44b5abec4de90a774: <blockquote class="twitter-tweet" data-in-reply-to="227882798978048000"
    width="550"><p>@<a href="https://twitter.com/bluelimemedia">bluelimemedia</a>
    @<a href="https://twitter.com/norcross">norcross</a> @<a href="https://twitter.com/sabreuse">sabreuse</a>
    @<a href="https://twitter.com/ericmann">ericmann</a> Here is the Malware entry
    for it - <a href="http://t.co/NBljkZHE" title="http://sucuri.net/malware/malware-entry-mwjs69693">sucuri.net/malware/malwar…</a></p>&mdash;
    Sucuri (@sucuri_security) <a href="https://twitter.com/sucuri_security/status/227884824885608451"
    data-datetime="2012-07-24T21:55:50+00:00">July 24, 2012</a></blockquote><script
    async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  _yoast_wpseo_linkdex: '76'
  _genesis_scripts_body_position: bottom
  _yoast_wpseo_primary_category: ''
  _wpas_skip_1588757: '1'
  _wpas_skip_1588752: '1'
  _wpas_skip_1650274: '1'
  _yoast_wpseo_focuskw_text_input: exploit
  _yoast_wpseo_content_score: '30'
  _wpghs_github_path: _posts/2012-07-31-the-anatomy-of-an-exploit.md
author:
  login: eamann
  email: eric@eamann.com
  display_name: Eric
  first_name: Eric
  last_name: Mann
permalink: "/tutorial/the-anatomy-of-an-exploit/"
---
<p>I'm a huge fan of security. I spend many a weekend experimenting with new encryption techniques, hash algorithms, and security protocols.</p>
<p>As a result, I also come across several different server exploits in the wild. PHP hacks, [cci].htaccess[/cci] hacks, JavaScript injection, etc. I once even saw a server hacked through a corrupt PNG image that installed a PHP console when it was loaded.</p>
<p>To a new developer, is is all pretty scary stuff. Here's an example of an exploit I came across last week - and how to both prevent and recover from it.<!--more--></p>
<h2>The Exploit</h2>
<p>A friend alerted the world via Twitter to an odd issue <a title="Undesired Redirect when using Hand-Held Devices" href="http://wordpress.org/support/topic/undesired-redirect-when-using-hand-held-devices">posted in the WordPress forums</a>.  A specific site was being redirected to a Russian website, but <em>only</em> if you visited with a mobile device.</p>
<p>I loaded the website both on my desktop and Android phone to see the difference - sure enough, the page loaded fine on the PC and the phone got Russian spam.</p>
<p>Next, I turned to Fiddler to see what else I could diagnose.</p>
<p>With a desktop user agent, everything came across the wire just fine.  Substituting a mobile user agent string - or any string containing the words "Android" or "iPhone" yielded somewhat different results:</p>
<p><img class="aligncenter size-full wp-image-313" title="Fiddler Malware Scan" src="{{ site.baseurl }}/assets/2012/07/malware-scan.png" alt="" width="650" height="328" /></p>
<p>There is now a coded block of JavaScript injected above the opening [cci]<!DOCTYPE html SYSTEM>[/cci] tag.  When decoded, this script writes a new script tag to the browser.  This script tag loads a remote URL that forces a redirect from the site you're on to a site of the hacker's choosing.</p>
<p>I followed up with my results in the forums, and mentioned them on Twitter.  That's when Sucuri Security joined the conversation and confirmed this is a known malware bug.</p>
<p>https://twitter.com/sucuri_security/status/227884824885608451</p>
<h2>How To Fix It</h2>
<p>Most known bugs also have known fixes - in this case, the exploit was a poorly secured [cci].htaccess[/cci] file that loads the extra script based on the user agent passed in the request.  Flushing the file is usually enough to remove it.</p>
<p>But that's never enough for me.</p>
<p>Once an attacker has access to your system, they'll likely install more than one back door.  Yes, [cci].htaccess[/cci] is obviously corrupt.  But there might be code lurking in a random PHP or JavaScript file on the server, just waiting to re-infect your site.</p>
<p>The <em>best</em> way to recover <strong>a WordPress site </strong>is to:</p>
<ol>
<li>Change your FTP password (this might be the hacker's original way in)</li>
<li>Change your MySQL password (keep your database secure - also change this in [cci]wp-config.php[/cci])</li>
<li>Check your [cci]wp-config.php[/cci] file <strong>line by line</strong> to make sure it's clean. Compare it to the [cci]wp-config-sample.php[/cci] file from a <strong>fresh download </strong>of WordPress to be sure.</li>
<li>Reinstall WordPress. This means deleting <strong><em>everything</em></strong><em></em>except for your configuration file, themes, and plugins
<ul>
<li>Ideally, you'll also remove all themes and plugins and reinstall them from clean sources as well. If you can't, make sure you go through each line of every PHP file and make sure there isn't anything hinky going on there.[ref]Yes, I did just use the word hinky in a professional post. Get over it. :-)[/ref]</li>
</ul>
</li>
<li>Go through your entire [cci]/uploads[/cci] directoy and make sure no rogue files or scripts are lying around</li>
<li>Restore your database from the most recent (clean) backup
<ul>
<li>If you don't have a backup, get ready for a long night of going through data tables manually to be sure there isn't anything hiding in the database</li>
<li>And really, why <em>don't</em> you have an automated backup? Set one up now while you're at it!</li>
</ul>
</li>
<li>Ask another developer to double check your work to be sure you haven't missed anything.</li>
</ol>
<p>In a pinch, you can also hire the experts at <a title="Sucuri Security" href="http://sucuri.net/">Sucuri</a> to clean things up for you. They know what they're doing and have likely cleaned up this specific hack already.</p>
<h2>Don't Get Hacked in the First Place</h2>
<p>There's quite a bit you can do to <a title="Hardening WordPress" href="http://codex.wordpress.org/Hardening_WordPress">harden your site</a> <em>before</em> it gets hacked. Here are just a few quick recommendations:</p>
<ul>
<li>Change your WordPress admin password regularly. And don't use the same password anywhere else.</li>
<li>Use different passwords and logins for WordPress admin, FTP, and MySQL.</li>
<li>If you're running your own VPS, don't do <em>anything</em> as root.</li>
<li>If you can, turn off FTP altogether. If you absolutely need it, consider SFTP instead.</li>
<li>Check your system access logs for weirdness regularly.</li>
<li>Make routine backups of your filesystem and database so you can recover quickly from problems.</li>
<li>Consider signing up with a malware monitoring service - <a title="Sucuri Security" href="http://sucuri.net/">Sucuri</a> happens to offer this, too.</li>
</ul>
