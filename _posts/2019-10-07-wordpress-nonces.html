---
layout: post
title: 'WordPress Nonces: Why We Can''t Have Nice Things'
date: 2019-10-07 06:00:24.000000000 -07:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- PHP
- Technology
tags:
- security
- WordPress
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '2'
  _yoast_wpseo_focuskw_text_input: WordPress Nonces
  _yoast_wpseo_focuskw: nonces
  _yoast_wpseo_metadesc: WordPress' implementation of nonces was one of my first encounters
    with cryptographic protections in software development. It's too bad WordPress
    nonces aren't really nonces in the first place.
  _yoast_wpseo_linkdex: '67'
  _yoast_wpseo_content_score: '90'
  _genesis_scripts_body_position: bottom
  _yoast_wpseo_primary_category: '891'
  _publicize_twitter_user: "@EricMann"
  _yoast_wpseo_title: "%%title%% %%page%%"
  _wpas_done_all: '1'
  _wpas_skip_1588752: '1'
author:
  login: eamann
  email: eric@eamann.com
  display_name: Eric
  first_name: Eric
  last_name: Mann
permalink: "/tech/wordpress-nonces/"
excerpt: WordPress' implementation of nonces was one of my first encounters with cryptographic
  protections in software development. It's too bad WordPress nonces aren't really
  nonces in the first place ...
---
<p>WordPress' implementation of nonces was one of my first encounters with cryptographic protections in software development. It's too bad WordPress nonces aren't really nonces in the first place ...</p>
<h2>Nonces</h2>
<p>A <a href="https://en.wikipedia.org/wiki/Cryptographic_nonce"><strong>nonce</strong></a> is a "<strong>n</strong>umber used <strong>once</strong>." It's intended to be a random, unpredictable value that is tracked and required by the application to prevent replay-style attacks.</p>
<h2>WordPress Nonces</h2>
<p>WordPress nonces are, admittedly, not numbers and not used once. They're not nonces at all, but allegedly serve the same purpose in the application. Each nonce is a predictable string created by hashing the current user's ID with the name of the action they're trying to perform, the ID of their current authentication session, and the current nonce "tick."</p>
<p>In WordPress, the nonce click "ticks" every 12 hours. This means, for any given user/action/session combination you will create the <em>same</em> nonce every single time for 12 hours.</p>
<p>In addition, WordPress considers both the current nonce and the immediately previous nonce to be "valid" for performing nonce-protected operations. This means any nonce generated by WordPress is in fact valid for <em>24 hours</em>.</p>
<h3>The Problem with WordPress</h3>
<p>This issue here might not be immediately obvious. Considering this is the way WordPress has used "nonces" for so many years, it's an easy thing to miss.</p>
<p>The primary point of a nonce is to prevent replay attacks - someone intercepting a request cannot reuse a previously used nonce.</p>
<p>In WordPress, nonces are <em>expected</em> to be reused. Many times. Over several hours!</p>
<p>While WordPress nonces might serve as useful <a href="https://en.wikipedia.org/wiki/Cross-site_request_forgery#Prevention">CSRF tokens</a> in certain circumstances, they fall down horribly when providing <em>actual</em> protection against replay attacks in the WordPress admin.</p>
<h2>A Path Forward?</h2>
<p>I spent some time working with a consulting client on "true nonces" for WordPress some months ago. The system I put in place added a table to the database and tracked any nonce as it was used. Each nonce was a truly random number, created with PHP's <tt>random_bytes()</tt> method, and bound to a specific user, authentication session, and action. The thing is, I didn't need to <em>validate</em> each nonce. I just tracked the nonce in the database and, if a subsequent request within a certain timeframe used the same random number, I'd reject the request.</p>
<p>This is how a nonce is meant to be used.[ref]Tracking the reason a nonce was created was a routine I added to try to marry a <em>true</em> nonce implementation with WordPress' non-nonce pseudo-CSRF implementation. I'd track the fields to override <tt>wp_verify_nonce()</tt>, but that's also how I identified the issues in the first place.[/ref] Unfortunately, it broke everything. My client at the time was using Beaver Builder, which in itself is a fantastic platform, but the system also uses a WordPress nonce to protect AJAX actions in the admin. Since I only allowed a nonce to be used once, my client could only save one setting at a time. The nonce issued for that first AJAX request would be stored in the database and, the next time a save was triggered, the request would fail due to nonce reuse.</p>
<p>This shows us the fatal flaw with WordPress' implementation. It also shows us what we'll need to do within WordPress if we ever want to support true nonces. We need a new table. We need a new verification routine. And we need some way to reconcile the fact that WordPress has misused the term "nonce" for over a decade in the first place!</p>
<p>The path forward requires a <em>major</em> paradigm shift in WordPress development. We need to add true cryptographic operations. We need to (potentially) rename a horrible misnomer that, frankly, is setting up thousands of developers to make mistakes in their future. And we need to help educate thousands of developers about proper security controls in their APIs. It's possible, but the path forward looks incredibly steep from here.</p>
