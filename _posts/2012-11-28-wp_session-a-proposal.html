---
layout: post
title: 'WP_Session: A Proposal'
date: 2012-11-28 11:00:00.000000000 -08:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories:
- Technology
tags:
- WordPress
meta:
  _yoast_wpseo_linkdex: '80'
  _edit_last: '2'
  _yoast_wpseo_focuskw: session
  _yoast_wpseo_title: 'WP_Session: Sessions in WordPress - A Proposal'
  _yoast_wpseo_metadesc: WordPress doesn't support sessions.  Here's my proposal for
    how that could change.
  _scribe_content_analysis: 'O:8:"stdClass":7:{s:8:"docScore";s:2:"88";s:9:"docScoreE";a:1:{i:0;s:5:"Hyper";}s:11:"fleschScore";s:14:"very
    difficult";s:8:"keywords";a:9:{i:0;O:8:"stdClass":12:{s:3:"kwc";s:4:"4.88";s:3:"kwd";s:4:"3.97";s:3:"kwe";a:0:{}s:3:"kwf";s:2:"15";s:3:"kwl";s:1:"1";s:7:"kwlText";s:7:"Primary";s:3:"kwo";s:1:"A";s:4:"kwod";s:109:"Congratulations,
    this term strikes a good balance between search optimization and copywriting best
    practices.";s:3:"kwp";s:9:"Very High";s:3:"kwr";s:1:"1";s:3:"kws";s:2:"10";s:4:"text";s:9:"wordpress";}i:1;O:8:"stdClass":12:{s:3:"kwc";s:4:"2.88";s:3:"kwd";s:4:"2.65";s:3:"kwe";a:0:{}s:3:"kwf";s:2:"10";s:3:"kwl";s:1:"3";s:7:"kwlText";s:11:"Significant";s:3:"kwo";s:1:"C";s:4:"kwod";s:139:"While
    your copywriting is strong, consider writing more about this topic on your site
    and/or use this term more frequently in your content.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"3";s:3:"kws";s:1:"0";s:4:"text";s:7:"session";}i:2;O:8:"stdClass":12:{s:3:"kwc";s:4:"4.88";s:3:"kwd";s:4:"1.85";s:3:"kwe";a:0:{}s:3:"kwf";s:1:"7";s:3:"kwl";s:1:"1";s:7:"kwlText";s:7:"Primary";s:3:"kwo";s:1:"C";s:4:"kwod";s:139:"While
    your copywriting is strong, consider writing more about this topic on your site
    and/or use this term more frequently in your content.";s:3:"kwp";s:9:"Very High";s:3:"kwr";s:1:"2";s:3:"kws";s:1:"0";s:4:"text";s:8:"sessions";}i:3;O:8:"stdClass":12:{s:3:"kwc";s:3:"1.1";s:3:"kwd";s:4:"0.53";s:3:"kwe";a:2:{i:0;s:4:"KwET";i:1;s:4:"KwEM";}s:3:"kwf";s:1:"2";s:3:"kwl";s:1:"4";s:7:"kwlText";s:14:"Not
    Emphasized";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You will need to do some work
    for this term, including improving your copywriting and writing more about this
    topic on your site.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"9";s:3:"kws";s:1:"0";s:4:"text";s:11:"the
    session";}i:4;O:8:"stdClass":12:{s:3:"kwc";s:3:"1.1";s:3:"kwd";s:4:"0.26";s:3:"kwe";a:3:{i:0;s:4:"KwET";i:1;s:4:"KwEM";i:2;s:5:"KwELF";}s:3:"kwf";s:1:"1";s:3:"kwl";s:1:"4";s:7:"kwlText";s:14:"Not
    Emphasized";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You will need to do some work
    for this term, including improving your copywriting and writing more about this
    topic on your site.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"8";s:3:"kws";s:1:"0";s:4:"text";s:5:"users";}i:5;O:8:"stdClass":12:{s:3:"kwc";s:3:"1.1";s:3:"kwd";s:4:"0.53";s:3:"kwe";a:2:{i:0;s:4:"KwET";i:1;s:4:"KwEM";}s:3:"kwf";s:1:"2";s:3:"kwl";s:1:"4";s:7:"kwlText";s:14:"Not
    Emphasized";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You will need to do some work
    for this term, including improving your copywriting and writing more about this
    topic on your site.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"7";s:3:"kws";s:1:"0";s:4:"text";s:10:"session
    id";}i:6;O:8:"stdClass":12:{s:3:"kwc";s:3:"2.1";s:3:"kwd";s:4:"0.79";s:3:"kwe";a:2:{i:0;s:4:"KwET";i:1;s:4:"KwEM";}s:3:"kwf";s:1:"3";s:3:"kwl";s:1:"3";s:7:"kwlText";s:11:"Significant";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You
    will need to do some work for this term, including improving your copywriting
    and writing more about this topic on your site.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"4";s:3:"kws";s:1:"0";s:4:"text";s:3:"php";}i:7;O:8:"stdClass":12:{s:3:"kwc";s:4:"1.51";s:3:"kwd";s:4:"0.53";s:3:"kwe";a:1:{i:0;s:4:"KwET";}s:3:"kwf";s:1:"2";s:3:"kwl";s:1:"4";s:7:"kwlText";s:14:"Not
    Emphasized";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You will need to do some work
    for this term, including improving your copywriting and writing more about this
    topic on your site.";s:3:"kwp";s:8:"Very Low";s:3:"kwr";s:1:"5";s:3:"kws";s:1:"0";s:4:"text";s:6:"change";}i:8;O:8:"stdClass":12:{s:3:"kwc";s:4:"1.47";s:3:"kwd";s:4:"0.53";s:3:"kwe";a:1:{i:0;s:4:"KwEM";}s:3:"kwf";s:1:"2";s:3:"kwl";s:1:"4";s:7:"kwlText";s:14:"Not
    Emphasized";s:3:"kwo";s:1:"D";s:4:"kwod";s:129:"You will need to do some work
    for this term, including improving your copywriting and writing more about this
    topic on your site.";s:3:"kwp";s:6:"Medium";s:3:"kwr";s:1:"6";s:3:"kws";s:1:"0";s:4:"text";s:10:"a
    proposal";}}s:11:"scribeScore";s:2:"58";s:4:"tags";a:18:{i:0;s:9:"wordpress";i:1;s:7:"session";i:2;s:8:"sessions";i:3;s:11:"the
    session";i:4;s:5:"users";i:5;s:10:"session id";i:6;s:3:"php";i:7;s:6:"change";i:8;s:10:"a
    proposal";i:9;s:24:"php programming language";i:10;s:14:"load balancing";i:11;s:23:"cross-platform
    software";i:12;s:16:"internet privacy";i:13;s:15:"support session";i:14;s:12:"php
    sessions";i:15;s:11:"http cookie";i:16;s:4:"http";i:17;s:9:"proposals";}s:7:"request";O:8:"stdClass":4:{s:10:"html_title";s:46:"WP_Session:
    Sessions in WordPress - A Proposal";s:11:"description";s:82:"WordPress doesn''t
    support sessions.  Here''s my proposal for how that could change.";s:7:"content";s:5253:"<p>My
    first experience with WordPress was when a client asked me to hack apart the registration
    system to allow for simple custom referral links.  They wanted users to be placed
    at different user levels depending on the URL they used to sign up for an account.</p><p>My
    initial attempt was ... atrocious   When a user hit a referral link, I used a
    hook to change the default user level, then changed it back after they registered.
     The problems with this approach are so glaring, I won''t bother explaining them.
     Seriously, it was a stupid idea.</p><p>My refined attempt tried to hack WordPress
    to add PHP session support.  The redefined user level was stored in the [cci]$_SESSION[/cci]
    superglobal and pulled back out upon registration.  Less stupid, but still not
    very elegant.<!--more--></p><h2>The Problem with Sessions</h2><h3>Split Servers</h3><p>I
    came to despise sessions the first time I worked with a distributed system.  Basically,
    the system was composed of two web servers positioned behind a load balancer.
     Both web services pulled information from the same database.  When you requested
    the domain, the load balancer would forward your request to whichever server was
    under less of a load.  It was fast and efficient.  But we consistently had problems
    logging in.</p><p>The issue was that both webservers handled their sessions internally,
    and authentication was session based.  You could be logged in according to one
    server and be moving along just fine.  Then, on a subsequent request when the
    load balancer moved you to the other server, you were no longer logged in.</p><p>Queue
    months of headaches and debating session handling with the IT guys.</p><h3>Validation</h3><p>When
    you''re using a normal PHP [cci]$_SESSION[/cci], there''s a session cooking stored
    in your browser that gets sent with every request.  The server reads this cookie,
    finds the appropriate session file on the server, unserializes the data, and populates
    the superglobal.  Unfortunately, there''s no way to verify that <em>you</em> are
    actually the owner of the session.</p><p>The chances of someone guessing your
    session ID are miniscule, but possible.  All they''d need to do is spoof your
    session ID and voila, they''d have access to all of your session data as well.</p><h2>Use
    Case in WordPress</h2><p>I can hear you saying now, "so what?"  You''ll probably
    never want to use sessions in WordPress.  But I can think of a few situations
    where either [cci]$_SESSION[/cci] is already being used or where it would be hugely
    useful.</p><h3>Shopping Carts</h3><p>Just about every quality shopping cart solution
    I''ve seen for WordPress uses sessions or some form of custom server-side data
    store based on them.  It''s important to keep the actual cart and purchase information
    on the server to protect it from tampering.</p><h3>Per-User API Caching</h3><p>Recently
    I built a project that requested large chunks of appointment information from
    a remote API.  This is somewhat sensitive data, requested over SSL to protect
    it from prying eyes, and specific to each user so it can''t be cached in a generic
    WordPress option.  Originally, I passed the API response through to a cookie so
    it would live in the user''s browser (the data needs to be presented across multiple
    pages).  However, cookies have a finite size and some larger responses were being
    lost.</p><p>Instead, I ended up creating a transient with a unique ID for every
    response and storing this unique ID in a cookie so WordPress could map cached
    data to the user later.  Wait, that sounds <em>exactly</em> like a PHP session
    ...</p><h2>A Proposal</h2><p>I propose adding an object to WordPress.  Something
    that looks and feels a lot like [cci]$_SESSION[/cci] to developers, but takes
    advantage of WordPress'' database model and caching systems.</p><p>Essentially,
    every visitor will be issued a session by something like [cci]wp_session_start()[/cci].
     This session will be identified by a key stored as a browser cookie.  It will
    also be validated against the visitor''s IP address (stored in the [cci]WP_Session[/cci]
    instance itself).</p><p>Each [cci]WP_Session[/cci] object will act as a key-value
    store (similar to [cci]$_SESSION[/cci]):</p><p>...</p><h3>Storage</h3><p>The actual
    data in a WordPress session object will be stored in a short-lived transient.
     The expiration date of the transient will be advanced every time the object is
    touched (either a read or a write) because it''s still active.  It will essentially
    just be a serialized associative array and can store just about anything WordPress
    needs ot to store.</p><p>The advantage of using transients (which are just WordPress
    options) is that they can be backed by memcached in certain optimized configurations.
     Also, the session data will always be available where WordPress'' data is available
    since they both exist in the same place.</p><h2>Thoughts?</h2><p>Not everyone
    will have a use for sessions when developing with WordPress.  But having a standard,
    core object people can code against would be useful.  Is this something you could
    see yourself using?  When, where, and why?  Is this something that should be baked
    in to core to be available to all, or should it remain plugin territory?</p>";s:3:"url";s:18:"http://eamann.com/";}}'
  _wpas_done_all: '1'
  yourls_shorturl: http://eam.me/py
  _zem_rp_image: empty
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1409930509;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:3189;}i:1;a:1:{s:2:"id";i:6001;}i:2;a:1:{s:2:"id";i:6102;}}}}
  keen_postview_count_this_24_hours: '5'
  keen_postview_count_this_7_days: '41'
  keen_postview_count_this_30_days: '188'
  _wpghs_github_path: _posts/2012-11-28-wp_session-a-proposal.md
author:
  login: eamann
  email: eric@eamann.com
  display_name: Eric
  first_name: Eric
  last_name: Mann
permalink: "/tech/wp_session-a-proposal/"
---
<p>My first experience with WordPress was when a client asked me to hack apart the registration system to allow for simple custom referral links.  They wanted users to be placed at different user levels depending on the URL they used to sign up for an account.</p>
<p>My initial attempt was ... atrocious   When a user hit a referral link, I used a hook to change the default user level, then changed it back after they registered.  The problems with this approach are so glaring, I won't bother explaining them.  Seriously, it was a stupid idea.</p>
<p>My refined attempt tried to hack WordPress to add PHP session support.  The redefined user level was stored in the [cci]$_SESSION[/cci] superglobal and pulled back out upon registration.  Less stupid, but still not very elegant.<!--more--></p>
<h2>The Problem with Sessions</h2>
<h3>Split Servers</h3>
<p>I came to despise sessions the first time I worked with a distributed system.  Basically, the system was composed of two web servers positioned behind a load balancer.  Both web services pulled information from the same database.  When you requested the domain, the load balancer would forward your request to whichever server was under less of a load.  It was fast and efficient.  But we consistently had problems logging in.</p>
<p>The issue was that both webservers handled their sessions internally, and authentication was session based.  You could be logged in according to one server and be moving along just fine.  Then, on a subsequent request when the load balancer moved you to the other server, you were no longer logged in.</p>
<p>Queue months of headaches and debating session handling with the IT guys.</p>
<h3>Validation</h3>
<p>When you're using a normal PHP [cci]$_SESSION[/cci], there's a session cooking stored in your browser that gets sent with every request.  The server reads this cookie, finds the appropriate session file on the server, unserializes the data, and populates the superglobal.  Unfortunately, there's no way to verify that <em>you</em> are actually the owner of the session.</p>
<p>The chances of someone guessing your session ID are miniscule, but possible.  All they'd need to do is spoof your session ID and voila, they'd have access to all of your session data as well.</p>
<h2>Use Case in WordPress</h2>
<p>I can hear you saying now, "so what?"  You'll probably never want to use sessions in WordPress.  But I can think of a few situations where either [cci]$_SESSION[/cci] is already being used or where it would be hugely useful.</p>
<h3>Shopping Carts</h3>
<p>Just about every quality shopping cart solution I've seen for WordPress uses sessions or some form of custom server-side data store based on them.  It's important to keep the actual cart and purchase information on the server to protect it from tampering.</p>
<h3>Per-User API Caching</h3>
<p>Recently I built a project that requested large chunks of appointment information from a remote API.  This is somewhat sensitive data, requested over SSL to protect it from prying eyes, and specific to each user so it can't be cached in a generic WordPress option.  Originally, I passed the API response through to a cookie so it would live in the user's browser (the data needs to be presented across multiple pages).  However, cookies have a finite size and some larger responses were being lost.</p>
<p>Instead, I ended up creating a transient with a unique ID for every response and storing this unique ID in a cookie so WordPress could map cached data to the user later.  Wait, that sounds <em>exactly</em> like a PHP session ...</p>
<h2>A Proposal</h2>
<p>I propose adding an object to WordPress.  Something that looks and feels a lot like [cci]$_SESSION[/cci] to developers, but takes advantage of WordPress' database model and caching systems.</p>
<p>Essentially, every visitor will be issued a session by something like [cci]wp_session_start()[/cci].  This session will be identified by a key stored as a browser cookie.  It will also be validated against the visitor's IP address (stored in the [cci]WP_Session[/cci] instance itself).</p>
<p>Each [cci]WP_Session[/cci] object will act as a key-value store (similar to [cci]$_SESSION[/cci]):</p>
<p><code lang="php" width="570px"><br />
// Start a session.  This can be called directly or hard-coded<br />
// into WordPress' init functionality.<br />
wp_session_start();</p>
<p>global $wp_session;<br />
$wp_session['string'] = 'This is a string';<br />
$wp_session['object'] = new stdClass();<br />
$wp_session['array'] = array();</p>
<p>// Write out the session. Can be called directly or hard-coded<br />
// into WordPress' shutdown functionality.<br />
wp_session_commit();<br />
</code></p>
<h3>Storage</h3>
<p>The actual data in a WordPress session object will be stored in a short-lived transient.  The expiration date of the transient will be advanced every time the object is touched (either a read or a write) because it's still active.  It will essentially just be a serialized associative array and can store just about anything WordPress needs ot to store.</p>
<p>The advantage of using transients (which are just WordPress options) is that they can be backed by memcached in certain optimized configurations.  Also, the session data will always be available where WordPress' data is available since they both exist in the same place.</p>
<h2>Thoughts?</h2>
<p>Not everyone will have a use for sessions when developing with WordPress.  But having a standard, core object people can code against would be useful.  Is this something you could see yourself using?  When, where, and why?  Is this something that should be baked in to core to be available to all, or should it remain plugin territory?</p>
