<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Managing Gearman Securely | Things that Matter Most</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Managing Gearman Securely" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The impact of an improperly-secured Gearman server grows with the importance of the application using it." />
<meta property="og:description" content="The impact of an improperly-secured Gearman server grows with the importance of the application using it." />
<meta property="og:site_name" content="Things that Matter Most" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-07-17T08:00:48-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Managing Gearman Securely" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Managing Gearman Securely","dateModified":"2017-07-17T08:00:48-07:00","datePublished":"2017-07-17T08:00:48-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/tech/managing-gearman-securely/"},"url":"/tech/managing-gearman-securely/","description":"The impact of an improperly-secured Gearman server grows with the importance of the application using it.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/authorimage.jpg" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">Things that Matter Most</a>
                    </h1>
                    
                    
                    <p class="site-description">Things that Matter Most</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item "><a href="/">Home</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/about">About</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/contact">Contact Me</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/search">Search</a></li>
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/ericallenmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                <main id="main" class="site-main">

    <article class="post-full inner">

        <header class="post-header">
            <div class="post-meta">
                <time class="post-date" datetime="2017-07-17">
                    July 17, 2017
                </time>
            </div><!-- .post-meta -->
            <h1 class="post-title">Managing Gearman Securely</h1>
        </header><!-- .post-header -->

        
        <div class="post-content">
            <p>A few years back, I was introduced to the world of task and job queues. A friend was writing a tutorial on <a href="https://www.rabbitmq.com/">RabbitMQ</a>, and I'd discovered <a href="http://gearman.org/">Gearman</a> as a potential solution for a large task I was working to complete. The idea of leveraging <em>multiple</em> servers to complete a single task in parallel was a foreign concept to me.</p>
<p>Once I'd mastered the idea of concurrent processing, I never looked back.</p>
<h2>Learning Curve</h2>
<p>The biggest downside of working with new server technologies is often that you need to learn the technology <em>on a server</em>. Keep in mind that I was learning Gearman while still using WAMP for local development; the idea of running a <em>local</em> VM hadn't occurred to me, so I learned the API by cowboy-coding against a Digital Ocean droplet.</p>
<p>Version control made my lessons (and mistakes) very public, so I worked to learn quickly.</p>
<p>Learning quickly meant I missed a step or two along the way in my education. I haven't worked with Gearman directly in a few years, so I took some time to brush up on the PHP interface to see what I could remember.</p>
<h2>The Job Server</h2>
<p>Gearman is split into two components - the server and workers. The server acts as a central "hub" that can accept job information from various clients and make it available to workers when they come online. There isn't much to the application itself; it's a daemon that runs persistently on the server and holds job data (both incoming and outgoing) in memory until it's needed.</p>
<p>Gearman <em>can</em> work with a persistent database backend to keep information around in the event of a reboot. If your application is mission-critical (i.e. billing) or takes a long time to complete (i.e. sending email newsletter subscriptions), maintaining a persistent backend is a good idea.</p>
<p>Installation <a href="http://gearman.org/getting-started/#installing">is straight-forward</a>, thanks to package managers for all of the major Linux server distributions. Some developers have even built <a href="https://hub.docker.com/r/kendu/gearman/">Dockerized distributions</a>, if that's your thing. The point is: you need a server somewhere, listening on port 4730, that both workers and clients can connect to.</p>
<h2>Workers</h2>
<p>Workers are, usually, simple PHP scripts that can be daemonized on the server. Your approach to daemonization is up to you - in the past, I've used Supervisord to keep a few copies of the script running or have Dockerized the process with a restart declaration.</p>
<p>The script itself merely registers a "function" with the Gearman server. Like any other piece of PHP code, this function takes arguments and returns data, it just takes its arguments from a dynamic process (Gearman) and returns data to the same.</p>
<p>Assume for now you have the desire to process PDF documents in bulk on the server, for optical character recognition, machine learning, or some other purpose. There are a lot of documents to import, so you want to parallelize the operation over multiple worker processes (and potentially multiple servers as well). Your code might take the form of a <tt>PHPImporter</tt> object with a single <tt>import()</tt> method:</p>
<p><code lang="php"><br />
// worker.php<br />
$importer = new PDFImporter();<br />
$worker = new GearmanWorker();<br />
$worker->addServer( 'localhost', 4730 );<br />
$worker->addFunction( 'import', array( $importer, 'import' );<br />
while( $worker->work() );<br />
</code></p>
<p>For the sake of this example, the worker script will run on the same server that's running Gearman itself, hence the binding to <tt>localhost</tt> above. In a real-world example, the local reference would be replaced with the IP address of the central server (or <em>multiple</em> servers in a distributed case).</p>
<p>This worker will run forever and will wait until a task is available on the local Gearman hub to process. It exposes a single function to the Gearman server, though it could expose <em>many</em>. Likewise, there could be multiple workers exposing <em>different</em> functions all to the same hub.</p>
<p>The beauty of Gearman is that you can use different languages to build the workers. This example uses PHP alone, but there are libraries for Java, Python, Ruby, Go, and many other languages as well. In theory, you could write have two workers written in different languages expose the <em>same function</em> to Gearman.</p>
<h2>The Client</h2>
<p>The client is just as simple. It's an operation within PHP (or your language of choice) that connects to Gearman and publishes a job to be processed. Often, you'll want to run a job in the <em>background</em>, meaning the main application doesn't wait for the take to complete before completing itself. This would allow a single application to create multiple jobs at once, then exit back to a browser or command line for further instruction.</p>
<p><code lang="php"><br />
// app.php<br />
$client = new GearmanClient();<br />
$client->addServer( 'localhost', 4730 );<br />
$job = $client->doBackground( 'import', $file . '||:||' . $email );<br />
$db->record( $job );<br />
</code></p>
<p>Gearman automatically returns a job ID that can be used to query for the job's status later on, if required. The example above fits with our PDF import illustration from earlier and instructs a Gearman server to execute a function named "import," passing it a concatenated string with a filename and an email address for later notification.</p>
<p><em>Keep in mind</em> that Gearman workloads (the second argument in the invocation) are only strings. In this example we're passing a filename, but the workload could just as easily be the base64-encoded binary body of the file itself. Gearman supports messages up to 4GB in size - the only limit here is the bandwidth the client has available.</p>
<h2>Security</h2>
<p>When I first set up a Gearman server, I didn't fully understand the ramifications of leaving the server in the public space. I was somewhat new to server maintenance, so while I could follow a tutorial to install a new application, I didn't <em>really</em> understand what was going on. This meant the server I'd built was completely exposed to the Internet - <em>anyone could connect to my Gearman server</em> whether they were running my code or not.</p>
<p>Think about that for a moment.</p>
<p>Anyone who knew I was running Gearman and the IP address I was using could leverage my server for their own purposes. Among other things, they could:</p>
<ul>
<li>Enumerate the functions I had registered on the server</li>
<li><em>Invoke</em> a function I had registered (even with a malicious or inaccurate payload)</li>
<li><em>Register their own functions</em> on the server</li>
</ul>
<p>Given Gearman's flexibility, a third party could even register a new worker to manage an already-registered function. Gearman would happily forward along any invocations, failing to distinguish between <em>legitimate</em> workers coded by me and malicious workers coded by a third party.</p>
<p>With the PDF processing server illustrated in the examples above, this might not be too much of an issue. Our machine learning database would be missing a few documents or might have some junk data inserted by a third party. If Gearman were instead being used to parallelize stock trades or process credit transactions or notify medical study participants of information ...</p>
<p>The impact of an improperly-secured Gearman server grows with the importance of the application using it.</p>
<h3>In the Wild</h3>
<p>I use a tool called <a href="https://www.shodan.io/">Shodan</a> on occasion to check that my servers (and Raspberry Pi clusters) are properly locked down while still visible on the public Internet. Shodan is an amazing tool, but it's also a treasure trove of information for potentially malicious parties as well. In addition to scanning specific IP addresses, it also maintains a directory of machines listening on specific ports.</p>
<p>My last check through Shodan showed over 8,000 individual servers listening on port 4730, the default port for Gearman. I didn't drill down much further than that,[ref]I did <em>not</em> connect to any of these machines. I merely enumerated the cached listings stored in Shodan's public database. Accessing someone else's computer system without authorization is illegal.[/ref] but Shodan ran a simple status query when it indexed these machines; the public database lists both the machines <em>and</em> their registered functions.</p>
<p>Remember, if your machine is visible to tools like Shodan, it's visible to malicious third parties who can manipulate or steal your data.</p>
<h3>Locking things Down</h3>
<p>Thankfully, the situation doesn't have to be dire. Gearman itself doesn't have any authentication, but the server <em>running</em> it can protect the daemon from abuse. Simply configure your server's firewall to block connections on port 4730 from everything <em>except</em> <tt>localhost</tt> and any specific, whitelisted servers. Shodan won't be able to index you and third parties won't be able to abuse your installation.</p>
<p>Gearman is a powerful application that you can and should be using to parallelize the processing done by your PHP server. It's <em>also</em> something that can easily expose you and your team to undue stress if not properly configured and secured. Take some time today to lock your Gearman servers down.</p>
<p>Then take some <em>more</em> time to ensure your other hosted applications are properly protected as well.</p>

        </div>
        <footer class="post-footer">
            <div class="post-share">
                <span class="post-share-title">Share:</span>
                <a target="_blank"
                    href="https://twitter.com/share?text=Managing+Gearman+Securely&amp;url=https://ttmm.iotech/managing-gearman-securely/">Twitter</a>
                <a target="_blank"
                    href="https://www.facebook.com/sharer/sharer.php?u=https://ttmm.iotech/managing-gearman-securely/">Facebook</a>
            </div><!-- .share-post -->
            
            <p class="post-cats">
                <span class="post-share-title">Filed under </span>
                <a href="/categories/index.html#Technology"
                    rel="category">Technology</a>
                
            </p>
            
            
            <p class="post-tags">
                <span class="post-share-title">Tagged with </span>
                <a href="/tags/index.html#Gearman"
                    rel="tag">Gearman</a>
                <a href="/tags/index.html#PHP"
                    rel="tag">PHP</a>
                <a href="/tags/index.html#security"
                    rel="tag">security</a>
                
            </p>
            
        </footer>
        
    </article>
    
    <section class="read-next inner">
        <h2 class="read-next-title">Read Next</h2>
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="July 10, 2017">July 10, 2017</time>
                </div>
                <h3 class="post-title"><a href="/faith/job-definitions/">Job Definitions</a>
                </h3>
            </header>
        </article>
        
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="July 19, 2017">July 19, 2017</time>
                </div>
                <h3 class="post-title"><a href="/journal/how-i-started-speaking/">How I Started Speaking</a></h3>
            </header>
        </article>
        
    </section><!-- .read-next -->

</main><!-- .site-main -->


                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">Things that Matter Most</a> &copy; 2021. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4156949-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-4156949-6', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>