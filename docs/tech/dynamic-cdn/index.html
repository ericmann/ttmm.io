<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Dynamic CDN: PHP and Checksums | Things that Matter Most</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Dynamic CDN: PHP and Checksums" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The general gist of Dynamic CDN is to scan page content before returning it to the browser and dynamically replace locally-hosted assets (images, scripts, styles, etc) with their CDN-hosted equivalents. The trick is returning consistent CDN urls for hosted assets - the plugin uses PHP to generate a checksum for asset references so it can select the perfect URL." />
<meta property="og:description" content="The general gist of Dynamic CDN is to scan page content before returning it to the browser and dynamically replace locally-hosted assets (images, scripts, styles, etc) with their CDN-hosted equivalents. The trick is returning consistent CDN urls for hosted assets - the plugin uses PHP to generate a checksum for asset references so it can select the perfect URL." />
<meta property="og:site_name" content="Things that Matter Most" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-03-21T08:00:48-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Dynamic CDN: PHP and Checksums" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"Dynamic CDN: PHP and Checksums","dateModified":"2014-03-21T08:00:48-07:00","datePublished":"2014-03-21T08:00:48-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/tech/dynamic-cdn/"},"url":"/tech/dynamic-cdn/","description":"The general gist of Dynamic CDN is to scan page content before returning it to the browser and dynamically replace locally-hosted assets (images, scripts, styles, etc) with their CDN-hosted equivalents. The trick is returning consistent CDN urls for hosted assets - the plugin uses PHP to generate a checksum for asset references so it can select the perfect URL.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/authorimage.jpg" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">Things that Matter Most</a>
                    </h1>
                    
                    
                    <p class="site-description">Things that Matter Most</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item "><a href="/">Home</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/about">About</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/contact">Contact Me</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/search">Search</a></li>
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/ericallenmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                <main id="main" class="site-main">

    <article class="post-full inner">

        <header class="post-header">
            <div class="post-meta">
                <time class="post-date" datetime="2014-03-21">
                    March 21, 2014
                </time>
            </div><!-- .post-meta -->
            <h1 class="post-title">Dynamic CDN: PHP and Checksums</h1>
        </header><!-- .post-header -->

        
        <div class="post-content">
            <p>The other day, I took on the task of extending a CDN plugin to <a title="Dynamic CDN" href="https://github.com/ericmann/dynamic-cdn">allow multiple origin domains</a>.  Unfortunately, the CDN plugin we were working with only allowed 1 domain.</p>
<p>If you've ever worked with resource-intensive website, you've likely learned that parallelizing asset downloads leads to increased performance.  As a result, it's a good idea to use <em>multiple</em> static domains to server your content to allow the browser to pull in as much content as is can quickly.</p>
<h2>PHP and Constants</h2>
<p>The convenient thing about the original plugin was its used of a configuration constant for specifying the CDN domain.  Drop the plugin in [cci]/mu-plugins[/cci], set up a constant in your [cci]wp-config.php[/cci], and you're ready to go.</p>
<p>Sadly, this doesn't allow for parallel asset downloads.</p>
<p>Sadder still, you can't define an <em>array</em> as a <em>constant</em> in PHP.  I had to look for another alternative.<em><br />
</em></p>
<p>The first draft utilized a Singleton-style object factory to create the CDN object.  You then added as many domains as you want programatically.  This worked pretty well, but to make it run on production you now need to define <em>two</em> must-use plugins instead of one.  The alternative was to somehow force a constant to work as an array.</p>
<p>Defining your multiple CDN domains as a comma-delimited list looks messy, but it works just fine.  The constructor of the CDN object reads in the constant, [cci]explode()[/cci]s the list, [cci]trim()[/cci]s off any accidental whitespace, and moves merrily along.</p>
<h2>Spreading the Load</h2>
<p>Once we had multiple CDN domains available, we needed a way to route assets somewhat evenly amongst them.</p>
<p>We also wanted to make sure that individual assets always mapped to the <em>same</em> CDN domain so that browsers would cache them appropriately - this meant randomly mapping images to [cci]cdn1.domain.com[/cci] versus [cci]cdn2.domain.com[/cci] wouldn't be a safe idea as images would switch, at random, from one CDN to the other on repeated page loads.</p>
<p>Also, running a round-robin between the available domains would only be stable so long as new images were never added to the page.  A new image at the top would force everything to swap to a different domain, thus busting the browser cache.</p>
<p>My solution - a rarely used PHP function called <a title="crc32" href="http://www.php.net/manual/en/function.crc32.php">[cci]crc32()[/cci]</a>.</p>
<h2>Checksums</h2>
<p>Using PHP's built-in [cci]crc32()[/cci] function, I can reliably reduce any asset url to an integer.  Every image url will <em>always</em> map down to the same checksum, meaning it's independent of load time, processing time, or visitor.</p>
<p>Further, I can calculate the <em><a title="Arithmetic Operators" href="http://www.php.net/manual/en/language.operators.arithmetic.php">modulus</a></em> of that checksum against the number of available CDN urls, generating an array key I can then use to select a specific CDN url.  This all boils down to one magic little function:</p>
<p><code lang="php">/**<br />
 * Get a CDN path for a given file, using a reduced checksum to automatically select from an array of available domains.<br />
 *<br />
 * @param string $file_path<br />
 *<br />
 * @return string<br />
 */<br />
public function cdn_domain( $file_path ) {<br />
    // First, get a checksum for the file path to give us the index we'll use from the CDN domain array.<br />
    $index = abs( crc32( $file_path ) ) % count( $this->cdn_domains );</p>
<p>    // Return the correct CDN path to the file<br />
    return apply_filters( 'dynamic_cdn_domain_for_file', $this->cdn_domains[ $index ], $file_path );<br />
}</code></p>
<p>The result of the above - every image on the site maps to a single, reliable CDN url every time.</p>
<h2>Open Source</h2>
<p>My new CDN plugin is <a href="https://github.com/ericmann/dynamic-cdn" title="Dynamic CDN">freely available on GitHub</a> for all to enjoy (or critique).</p>
<p>It borrows heavily from the CDN component of Mark Jaquith's WP Stack toolkit, which is <a href="https://github.com/markjaquith/WP-Stack" title="WP Stack">also available on GitHub</a>.</p>
<p>The general gist is to scan page content before returning it to the browser and dynamically replace locally-hosted assets (images, scripts, styles, etc) with their CDN-hosted equivalents.  If you use a service like Photon, rewriting your image tags to reference Photon-hosted versions of the same assets will drastically improve your site's performance.</p>
<p>If you use another CDN system, minor changes might be required to get things to work right.  Luckily, the plugin exposed a wide variety of filters for just that purpose.  If you give it a try and find more filters (or other changes) are needed, I'll be glad to review any pull requests.</p>

        </div>
        <footer class="post-footer">
            <div class="post-share">
                <span class="post-share-title">Share:</span>
                <a target="_blank"
                    href="https://twitter.com/share?text=Dynamic+CDN%3A+PHP+and+Checksums&amp;url=https://ttmm.iotech/dynamic-cdn/">Twitter</a>
                <a target="_blank"
                    href="https://www.facebook.com/sharer/sharer.php?u=https://ttmm.iotech/dynamic-cdn/">Facebook</a>
            </div><!-- .share-post -->
            
            <p class="post-cats">
                <span class="post-share-title">Filed under </span>
                <a href="/categories/index.html#Technology"
                    rel="category">Technology</a>
                
            </p>
            
            
            <p class="post-tags">
                <span class="post-share-title">Tagged with </span>
                <a href="/tags/index.html#Cdn"
                    rel="tag">Cdn</a>
                <a href="/tags/index.html#crc32"
                    rel="tag">crc32</a>
                <a href="/tags/index.html#parallel+download"
                    rel="tag">parallel download</a>
                <a href="/tags/index.html#WordPress"
                    rel="tag">WordPress</a>
                
            </p>
            
        </footer>
        
    </article>
    
    <section class="read-next inner">
        <h2 class="read-next-title">Read Next</h2>
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="March 20, 2014">March 20, 2014</time>
                </div>
                <h3 class="post-title"><a href="/writing/two-poems/">Poetry is Code</a>
                </h3>
            </header>
        </article>
        
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="March 22, 2014">March 22, 2014</time>
                </div>
                <h3 class="post-title"><a href="/faith/rights-and-derivative-works/">Rights and Derivative Works</a></h3>
            </header>
        </article>
        
    </section><!-- .read-next -->

</main><!-- .site-main -->


                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">Things that Matter Most</a> &copy; 2021. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4156949-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-4156949-6', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>