<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
        <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>The Hackiest Hack that Ever Was Hacked | Things that Matter Most</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="The Hackiest Hack that Ever Was Hacked" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I was first introduced to Plupload when I was building websites in .Net. &nbsp;I had some great HTML5 file upload tools that worked wonders in my browser of choice, but most of my colleagues (and about 80% of our clients) were using a browser that didn&#39;t support the API. &nbsp;I used Plupload as a reliable cross-browser tool that would use HTML5 where available and fall back on Silverlight for those users who hadn&#39;t yet upgraded to a&nbsp;real browser. Cooler still, WordPress incorporated Plupload in to core! &nbsp;Now I could use the same tool for both my .Net projects and my open-source WordPress projects. &nbsp;I already knew the API forwards and backwards, so I was set. Until the first time I tried to manipulate a Plupload event in WordPress. Hacking Through The Brush Like many other good JavaScript projects, Plupload doesn&#39;t litter the global namespace with a lot of meaningless crud. &nbsp;Unfortunately, this means that unless you store a reference to your shiny new Uploader instance, you won&#39;t be able to talk to it again. In the 3.4 days, WordPress built out a bunch of handlers for the various Plupload events. &nbsp;Then they buried the Uploader instance in a closure-scoped variable. Inside an iFrame. Needless to say, overriding or augmenting any of the stock upload events became somewhat impossible. &nbsp;As a matter of fact, I stated so in response to a WordPress Stack Exchange question about manipulating these events just over a year ago. Finally, a Solution A project I&#39;m working on right now is still using the 3.4-style media uploader.[ref]The reasons for this are beyond the scope of this post.[/ref] &nbsp;After implementing the uploader, my client made a request to lock down file types allowed in the upload to images only. &nbsp;Conveniently, Plupload gives us a FilesAdded event where we can hook in to scan the newly added file and either allow it or yell at the user. Unfortunately, this event is assigned to the closure-scoped upLoader variable we referenced above. &nbsp;Furthermore, Plupload and its supporting scripts are being loaded inside an iFrame on the page, making it difficult to hook in at all. Luckily, though, the FilesAdded event is merely a wrapper for a globally-scoped (in terms of the iFrame, anyway) fileQueued function. &nbsp;Using a few clever hacks, we can intercept this fileQueued function, replace it with one of our own, and keep chugging merrily along. /** * Object to encapsulate ThickBox-powered image uploads. * * @constructor * * @param {String} label ThickBox header text * @parap {Object} picker jQuery double-click target */ function ImagePicker( label, picker ) { var SELF = this, $picker = $( picker ), editor_store, ifWindow, fileQueued;&lt;/p&gt; /** * Handle the selection of an image. * * @param {String} html */ var send_handler = function( html ) { var imagePath = jQuery( html ).attr( &#39;href&#39; ); // Remove the modal overlay window.tb_remove(); // Restore original handlers window.send_to_editor = editor_store; ifWindow.fileQueued = fileQueued; // Trigger internal change event SELF.changed( imagePath ); }; /** * Our custom click event handler * * @param {Event} e */ var launchOverlay = function( e ) { e.preventDefault(); editor_store = window.send_to_editor; // Set up our new handler window.send_to_editor = send_handler; // Show the overlay window.tb_show( label, &#39;media-upload.php?TB_iframe=1&amp;width=640&amp;height=263&#39; ); $( document.getElementById( &#39;TB_iframeContent&#39; ) ).load( intercept_image_files ); }; /** * Intercept the file queueing process for plupload and block non-images. */ function intercept_image_files() { ifWindow = document.getElementById(&#39;TB_iframeContent&#39;).contentWindow; fileQueued = ifWindow.fileQueued; // Set new fileQueued handler ifWindow.fileQueued = function( fileObj ) { // If we&#39;re good, go for it! if ( SELF.isImage( fileObj.name ) ) { fileQueued( fileObj ); return; } // If we&#39;ve gotten this far, someone&#39;s trying to do something nasty. Stop them! window.alert( &#39;Sorry, that file doesn\&#39;t appear to be an image.&#39; ); }; } /** * Override this function to do some magic after an image is selected. * * @param {String} newUri The new image URL. * * @return {Boolean} */ SELF.changed = function( newUri ) { return false; }; $picker.on( &#39;dblclick&#39;, launchOverlay ); }; /** * Check if a file name is that of an image. * * @param {string} src * @returns {boolean} */ ImagePicker.prototype.isImage = function( src ) { var ext = src.split( &#39;.&#39; ).pop(); ext = ext.toLowerCase(); var extensions = [ &#39;jpg&#39;, &#39;jpeg&#39;, &#39;png&#39;, &#39;gif&#39; ]; for ( var i = 0; i &lt; extensions.length; i++ ) { var extension = extensions[i]; if ( ext === extension ) { return true; } } return false; }; var picker = new ImagePicker( &#39;Set Background Image&#39;, document.getElementById( &#39;image-picker&#39; ) ); &lt;/code&gt; Without going in to too much detail, the object above sets up a new ThickBox image picker. When you double-click the specified element on the page, an overlay will launch containing the media upload UI. When you select an image, a custom change handler is called so you can do whatever you need to with the path of the newly-uploaded image. To allow this custom handling, we have to store the original window.send_to_editor function somewhere, replace it with our own handler, then restore the original when closing the dialog. Handling the FilesAdded event is similar. After the iFrame loads, we grab a reference to its internal window scope, grab the original fileQueued function so we can store it somewhere, replace it with our own handler, and restore it when the dialog closes. In Summary As one of my coworkers put it: Can&#39;t is a four-letter word. The task of hacking around a somewhat closed API seemed daunting at first. Even now, the fact that it took me over a year to figure out this workaround is frustrating. Luckily, the new media uploader introduced with WordPress 3.5 is a little easier to play with in terms of hooking events. It actually exports the Plupload instance as part of the wp.Uploader object, so you can hook to events natively without such hacky workarounds. Still, it&#39;s nice to know that, even in the absence of advanced event management, it&#39;s possible to hook in to WordPress when you need to manipulate stock behavior. This flexibility is what continues to make WordPress a stellar platform for application development." />
<meta property="og:description" content="I was first introduced to Plupload when I was building websites in .Net. &nbsp;I had some great HTML5 file upload tools that worked wonders in my browser of choice, but most of my colleagues (and about 80% of our clients) were using a browser that didn&#39;t support the API. &nbsp;I used Plupload as a reliable cross-browser tool that would use HTML5 where available and fall back on Silverlight for those users who hadn&#39;t yet upgraded to a&nbsp;real browser. Cooler still, WordPress incorporated Plupload in to core! &nbsp;Now I could use the same tool for both my .Net projects and my open-source WordPress projects. &nbsp;I already knew the API forwards and backwards, so I was set. Until the first time I tried to manipulate a Plupload event in WordPress. Hacking Through The Brush Like many other good JavaScript projects, Plupload doesn&#39;t litter the global namespace with a lot of meaningless crud. &nbsp;Unfortunately, this means that unless you store a reference to your shiny new Uploader instance, you won&#39;t be able to talk to it again. In the 3.4 days, WordPress built out a bunch of handlers for the various Plupload events. &nbsp;Then they buried the Uploader instance in a closure-scoped variable. Inside an iFrame. Needless to say, overriding or augmenting any of the stock upload events became somewhat impossible. &nbsp;As a matter of fact, I stated so in response to a WordPress Stack Exchange question about manipulating these events just over a year ago. Finally, a Solution A project I&#39;m working on right now is still using the 3.4-style media uploader.[ref]The reasons for this are beyond the scope of this post.[/ref] &nbsp;After implementing the uploader, my client made a request to lock down file types allowed in the upload to images only. &nbsp;Conveniently, Plupload gives us a FilesAdded event where we can hook in to scan the newly added file and either allow it or yell at the user. Unfortunately, this event is assigned to the closure-scoped upLoader variable we referenced above. &nbsp;Furthermore, Plupload and its supporting scripts are being loaded inside an iFrame on the page, making it difficult to hook in at all. Luckily, though, the FilesAdded event is merely a wrapper for a globally-scoped (in terms of the iFrame, anyway) fileQueued function. &nbsp;Using a few clever hacks, we can intercept this fileQueued function, replace it with one of our own, and keep chugging merrily along. /** * Object to encapsulate ThickBox-powered image uploads. * * @constructor * * @param {String} label ThickBox header text * @parap {Object} picker jQuery double-click target */ function ImagePicker( label, picker ) { var SELF = this, $picker = $( picker ), editor_store, ifWindow, fileQueued;&lt;/p&gt; /** * Handle the selection of an image. * * @param {String} html */ var send_handler = function( html ) { var imagePath = jQuery( html ).attr( &#39;href&#39; ); // Remove the modal overlay window.tb_remove(); // Restore original handlers window.send_to_editor = editor_store; ifWindow.fileQueued = fileQueued; // Trigger internal change event SELF.changed( imagePath ); }; /** * Our custom click event handler * * @param {Event} e */ var launchOverlay = function( e ) { e.preventDefault(); editor_store = window.send_to_editor; // Set up our new handler window.send_to_editor = send_handler; // Show the overlay window.tb_show( label, &#39;media-upload.php?TB_iframe=1&amp;width=640&amp;height=263&#39; ); $( document.getElementById( &#39;TB_iframeContent&#39; ) ).load( intercept_image_files ); }; /** * Intercept the file queueing process for plupload and block non-images. */ function intercept_image_files() { ifWindow = document.getElementById(&#39;TB_iframeContent&#39;).contentWindow; fileQueued = ifWindow.fileQueued; // Set new fileQueued handler ifWindow.fileQueued = function( fileObj ) { // If we&#39;re good, go for it! if ( SELF.isImage( fileObj.name ) ) { fileQueued( fileObj ); return; } // If we&#39;ve gotten this far, someone&#39;s trying to do something nasty. Stop them! window.alert( &#39;Sorry, that file doesn\&#39;t appear to be an image.&#39; ); }; } /** * Override this function to do some magic after an image is selected. * * @param {String} newUri The new image URL. * * @return {Boolean} */ SELF.changed = function( newUri ) { return false; }; $picker.on( &#39;dblclick&#39;, launchOverlay ); }; /** * Check if a file name is that of an image. * * @param {string} src * @returns {boolean} */ ImagePicker.prototype.isImage = function( src ) { var ext = src.split( &#39;.&#39; ).pop(); ext = ext.toLowerCase(); var extensions = [ &#39;jpg&#39;, &#39;jpeg&#39;, &#39;png&#39;, &#39;gif&#39; ]; for ( var i = 0; i &lt; extensions.length; i++ ) { var extension = extensions[i]; if ( ext === extension ) { return true; } } return false; }; var picker = new ImagePicker( &#39;Set Background Image&#39;, document.getElementById( &#39;image-picker&#39; ) ); &lt;/code&gt; Without going in to too much detail, the object above sets up a new ThickBox image picker. When you double-click the specified element on the page, an overlay will launch containing the media upload UI. When you select an image, a custom change handler is called so you can do whatever you need to with the path of the newly-uploaded image. To allow this custom handling, we have to store the original window.send_to_editor function somewhere, replace it with our own handler, then restore the original when closing the dialog. Handling the FilesAdded event is similar. After the iFrame loads, we grab a reference to its internal window scope, grab the original fileQueued function so we can store it somewhere, replace it with our own handler, and restore it when the dialog closes. In Summary As one of my coworkers put it: Can&#39;t is a four-letter word. The task of hacking around a somewhat closed API seemed daunting at first. Even now, the fact that it took me over a year to figure out this workaround is frustrating. Luckily, the new media uploader introduced with WordPress 3.5 is a little easier to play with in terms of hooking events. It actually exports the Plupload instance as part of the wp.Uploader object, so you can hook to events natively without such hacky workarounds. Still, it&#39;s nice to know that, even in the absence of advanced event management, it&#39;s possible to hook in to WordPress when you need to manipulate stock behavior. This flexibility is what continues to make WordPress a stellar platform for application development." />
<meta property="og:site_name" content="Things that Matter Most" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2013-05-01T12:00:17-07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="The Hackiest Hack that Ever Was Hacked" />
<meta name="twitter:site" content="@" />
<script type="application/ld+json">
{"@type":"BlogPosting","headline":"The Hackiest Hack that Ever Was Hacked","dateModified":"2013-05-01T12:00:17-07:00","datePublished":"2013-05-01T12:00:17-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"/tech/the-hackiest-hack-that-ever-was-hacked/"},"url":"/tech/the-hackiest-hack-that-ever-was-hacked/","description":"I was first introduced to Plupload when I was building websites in .Net. &nbsp;I had some great HTML5 file upload tools that worked wonders in my browser of choice, but most of my colleagues (and about 80% of our clients) were using a browser that didn&#39;t support the API. &nbsp;I used Plupload as a reliable cross-browser tool that would use HTML5 where available and fall back on Silverlight for those users who hadn&#39;t yet upgraded to a&nbsp;real browser. Cooler still, WordPress incorporated Plupload in to core! &nbsp;Now I could use the same tool for both my .Net projects and my open-source WordPress projects. &nbsp;I already knew the API forwards and backwards, so I was set. Until the first time I tried to manipulate a Plupload event in WordPress. Hacking Through The Brush Like many other good JavaScript projects, Plupload doesn&#39;t litter the global namespace with a lot of meaningless crud. &nbsp;Unfortunately, this means that unless you store a reference to your shiny new Uploader instance, you won&#39;t be able to talk to it again. In the 3.4 days, WordPress built out a bunch of handlers for the various Plupload events. &nbsp;Then they buried the Uploader instance in a closure-scoped variable. Inside an iFrame. Needless to say, overriding or augmenting any of the stock upload events became somewhat impossible. &nbsp;As a matter of fact, I stated so in response to a WordPress Stack Exchange question about manipulating these events just over a year ago. Finally, a Solution A project I&#39;m working on right now is still using the 3.4-style media uploader.[ref]The reasons for this are beyond the scope of this post.[/ref] &nbsp;After implementing the uploader, my client made a request to lock down file types allowed in the upload to images only. &nbsp;Conveniently, Plupload gives us a FilesAdded event where we can hook in to scan the newly added file and either allow it or yell at the user. Unfortunately, this event is assigned to the closure-scoped upLoader variable we referenced above. &nbsp;Furthermore, Plupload and its supporting scripts are being loaded inside an iFrame on the page, making it difficult to hook in at all. Luckily, though, the FilesAdded event is merely a wrapper for a globally-scoped (in terms of the iFrame, anyway) fileQueued function. &nbsp;Using a few clever hacks, we can intercept this fileQueued function, replace it with one of our own, and keep chugging merrily along. /** * Object to encapsulate ThickBox-powered image uploads. * * @constructor * * @param {String} label ThickBox header text * @parap {Object} picker jQuery double-click target */ function ImagePicker( label, picker ) { var SELF = this, $picker = $( picker ), editor_store, ifWindow, fileQueued;&lt;/p&gt; /** * Handle the selection of an image. * * @param {String} html */ var send_handler = function( html ) { var imagePath = jQuery( html ).attr( &#39;href&#39; ); // Remove the modal overlay window.tb_remove(); // Restore original handlers window.send_to_editor = editor_store; ifWindow.fileQueued = fileQueued; // Trigger internal change event SELF.changed( imagePath ); }; /** * Our custom click event handler * * @param {Event} e */ var launchOverlay = function( e ) { e.preventDefault(); editor_store = window.send_to_editor; // Set up our new handler window.send_to_editor = send_handler; // Show the overlay window.tb_show( label, &#39;media-upload.php?TB_iframe=1&amp;width=640&amp;height=263&#39; ); $( document.getElementById( &#39;TB_iframeContent&#39; ) ).load( intercept_image_files ); }; /** * Intercept the file queueing process for plupload and block non-images. */ function intercept_image_files() { ifWindow = document.getElementById(&#39;TB_iframeContent&#39;).contentWindow; fileQueued = ifWindow.fileQueued; // Set new fileQueued handler ifWindow.fileQueued = function( fileObj ) { // If we&#39;re good, go for it! if ( SELF.isImage( fileObj.name ) ) { fileQueued( fileObj ); return; } // If we&#39;ve gotten this far, someone&#39;s trying to do something nasty. Stop them! window.alert( &#39;Sorry, that file doesn\\&#39;t appear to be an image.&#39; ); }; } /** * Override this function to do some magic after an image is selected. * * @param {String} newUri The new image URL. * * @return {Boolean} */ SELF.changed = function( newUri ) { return false; }; $picker.on( &#39;dblclick&#39;, launchOverlay ); }; /** * Check if a file name is that of an image. * * @param {string} src * @returns {boolean} */ ImagePicker.prototype.isImage = function( src ) { var ext = src.split( &#39;.&#39; ).pop(); ext = ext.toLowerCase(); var extensions = [ &#39;jpg&#39;, &#39;jpeg&#39;, &#39;png&#39;, &#39;gif&#39; ]; for ( var i = 0; i &lt; extensions.length; i++ ) { var extension = extensions[i]; if ( ext === extension ) { return true; } } return false; }; var picker = new ImagePicker( &#39;Set Background Image&#39;, document.getElementById( &#39;image-picker&#39; ) ); &lt;/code&gt; Without going in to too much detail, the object above sets up a new ThickBox image picker. When you double-click the specified element on the page, an overlay will launch containing the media upload UI. When you select an image, a custom change handler is called so you can do whatever you need to with the path of the newly-uploaded image. To allow this custom handling, we have to store the original window.send_to_editor function somewhere, replace it with our own handler, then restore the original when closing the dialog. Handling the FilesAdded event is similar. After the iFrame loads, we grab a reference to its internal window scope, grab the original fileQueued function so we can store it somewhere, replace it with our own handler, and restore it when the dialog closes. In Summary As one of my coworkers put it: Can&#39;t is a four-letter word. The task of hacking around a somewhat closed API seemed daunting at first. Even now, the fact that it took me over a year to figure out this workaround is frustrating. Luckily, the new media uploader introduced with WordPress 3.5 is a little easier to play with in terms of hooking events. It actually exports the Plupload instance as part of the wp.Uploader object, so you can hook to events natively without such hacky workarounds. Still, it&#39;s nice to know that, even in the absence of advanced event management, it&#39;s possible to hook in to WordPress when you need to manipulate stock behavior. This flexibility is what continues to make WordPress a stellar platform for application development.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

    

    <!-- Site Favicon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" type="image/png" />

    <!-- Font Embed Code -->
	<link href="https://fonts.googleapis.com/css?family=Crimson+Text:400,400i,600,600i|Karla:400,400i,700,700i" rel="stylesheet">

    <!-- CSS Styles -->
    <link href="/assets/css/style.css" rel="stylesheet">
</head>



<body class="layout-post">
    <div id="page" class="site">
        <header id="masthead" class="site-header">
    <div class="site-header-wrap">
        <div class="site-header-inside">

            <div class="site-branding">
                
                <p class="profile">
                    <a href="/">
                        <img src="/assets/images/authorimage.jpg" alt="'s Picture"
                            class="avatar" />
                    </a>
                </p>
                <div class="site-identity">
                    
                    <h1 class="site-title">
                        <a href="/">Things that Matter Most</a>
                    </h1>
                    
                    
                    <p class="site-description">Things that Matter Most</p>
                    
                </div><!-- .site-identity -->
                
                <button id="menu-toggle" class="menu-toggle"><span class="screen-reader-text">Main Menu</span><span
                        class="icon-menu" aria-hidden="true"></span></button>
            </div><!-- .site-branding -->

            <nav id="main-navigation" class="site-navigation" aria-label="Main Navigation">
                <div class="site-nav-wrap">
                    <div class="site-nav-inside">
                    <ul class="menu">
                        
                        
                        
                        <li class="menu-item "><a href="/">Home</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/about">About</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/contact">Contact Me</a></li>
                        
                        
                        
                        <li class="menu-item "><a href="/search">Search</a></li>
                        
                    </ul>
                    <p class="social-links">
    
    <a href="https://twitter.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    <a href="https://github.com/ericmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
    
    
    
    
    <a href="https://www.linkedin.com/in/ericallenmann" target="_blank">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>
<!--
Font Awesome Free 5.5.0 by @fontawesome - https://fontawesome.com
License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
-->
    </a>
    
    
    
</p>
                    </div><!-- .site-nav-inside -->
                </div><!-- .site-nav-wrap -->
            </nav><!-- .site-navigation -->

        </div><!-- .site-header-inside -->
    </div><!-- .site-header-wrap -->
</header><!-- .site-header -->
        <div id="content" class="site-content fadeInDown delay_075s">
            <div class="inner-wide">
                <main id="main" class="site-main">

    <article class="post-full inner">

        <header class="post-header">
            <div class="post-meta">
                <time class="post-date" datetime="2013-05-01">
                    May 1, 2013
                </time>
            </div><!-- .post-meta -->
            <h1 class="post-title">The Hackiest Hack that Ever Was Hacked</h1>
        </header><!-- .post-header -->

        
        <div class="post-content">
            <p>I was first introduced to <a title="Plupload" href="http://www.plupload.com/">Plupload</a> when I was building websites in .Net. &nbsp;I had some great HTML5 file upload tools that worked wonders in my browser of choice, but most of my colleagues (and about 80% of our clients) were using a browser that didn't support the API. &nbsp;I used Plupload as a reliable cross-browser tool that would use HTML5 where available and fall back on Silverlight for those users who hadn't yet upgraded to a&nbsp;<em>real</em> browser.</p>
<p>Cooler still, WordPress incorporated Plupload in to core! &nbsp;Now I could use the same tool for both my .Net projects and my open-source WordPress projects. &nbsp;I already knew the API forwards and backwards, so I was set.</p>
<p>Until the first time I tried to manipulate a Plupload event in WordPress.<!--more--></p>
<h2>Hacking Through The Brush</h2>
<p>Like many other good JavaScript projects, Plupload doesn't litter the global namespace with a lot of meaningless crud. &nbsp;Unfortunately, this means that unless you store a reference to your shiny new Uploader instance, you won't be able to talk to it again.</p>
<p>In the 3.4 days, WordPress built out <a href="http://core.trac.wordpress.org/browser/trunk/wp-includes/js/plupload/handlers.js" title="handlers.js">a bunch of handlers for the various Plupload events</a>. &nbsp;Then they buried the <tt>Uploader</tt> instance in a closure-scoped variable.</p>
<p>Inside an iFrame.</p>
<p>Needless to say, overriding or augmenting any of the stock upload events became somewhat impossible. &nbsp;As a matter of fact, I stated so in response to a <a title="Plupload Intergration in a meta-box?" href="http://wordpress.stackexchange.com/q/33173/46">WordPress Stack Exchange question</a> about manipulating these events just over a year ago.</p>
<h2>Finally, a Solution</h2>
<p>A project I'm working on right now is still using the 3.4-style media uploader.[ref]The reasons for this are beyond the scope of this post.[/ref] &nbsp;After implementing the uploader, my client made a request to lock down file types allowed in the upload to images only. &nbsp;Conveniently, Plupload gives us a <tt>FilesAdded</tt> event where we can hook in to scan the newly added file and either allow it or yell at the user.</p>
<p>Unfortunately, this event is assigned to the closure-scoped upLoader variable we referenced above. &nbsp;Furthermore, Plupload and its supporting scripts are being loaded inside an iFrame on the page, making it difficult to hook in at all.</p>
<p>Luckily, though, the FilesAdded event is merely a wrapper for a globally-scoped (in terms of the iFrame, anyway) <tt>fileQueued</tt> function. &nbsp;Using a few clever hacks, we can intercept this <tt>fileQueued</tt> function, replace it with one of our own, and keep chugging merrily along.</p>
<p><code lang="javascript" height="700"><br />
/**<br />
 * Object to encapsulate ThickBox-powered image uploads.<br />
 *<br />
 * @constructor<br />
 *<br />
 * @param {String} label  ThickBox header text<br />
 * @parap {Object} picker jQuery double-click target<br />
 */<br />
function ImagePicker( label, picker ) {<br />
    var SELF = this,<br />
        $picker = $( picker ),<br />
        editor_store, ifWindow, fileQueued;</p>
<p>    /**<br />
     * Handle the selection of an image.<br />
     *<br />
     * @param {String} html<br />
     */<br />
    var send_handler = function( html ) {<br />
        var imagePath = jQuery( html ).attr( 'href' );</p>
<p>        // Remove the modal overlay<br />
        window.tb_remove();</p>
<p>        // Restore original handlers<br />
        window.send_to_editor = editor_store;<br />
        ifWindow.fileQueued = fileQueued;</p>
<p>        // Trigger internal change event<br />
        SELF.changed( imagePath );<br />
    };</p>
<p>    /**<br />
     * Our custom click event handler<br />
     *<br />
     * @param {Event} e<br />
     */<br />
    var launchOverlay = function( e ) {<br />
        e.preventDefault();</p>
<p>        editor_store = window.send_to_editor;</p>
<p>        // Set up our new handler<br />
        window.send_to_editor = send_handler;</p>
<p>        // Show the overlay<br />
        window.tb_show( label, 'media-upload.php?TB_iframe=1&width=640&height=263' );</p>
<p>        $( document.getElementById( 'TB_iframeContent' ) ).load( intercept_image_files );<br />
    };</p>
<p>    /**<br />
     * Intercept the file queueing process for plupload and block non-images.<br />
     */<br />
    function intercept_image_files() {<br />
        ifWindow = document.getElementById('TB_iframeContent').contentWindow;<br />
        fileQueued = ifWindow.fileQueued;</p>
<p>        // Set new fileQueued handler<br />
        ifWindow.fileQueued = function( fileObj ) {<br />
            // If we're good, go for it!<br />
            if ( SELF.isImage( fileObj.name ) ) {<br />
                fileQueued( fileObj );</p>
<p>                return;<br />
            }</p>
<p>            // If we've gotten this far, someone's trying to do something nasty. Stop them!<br />
            window.alert( 'Sorry, that file doesn\'t appear to be an image.' );<br />
        };<br />
    }</p>
<p>    /**<br />
     * Override this function to do some magic after an image is selected.<br />
     *<br />
     * @param {String} newUri The new image URL.<br />
     *<br />
     * @return {Boolean}<br />
     */<br />
    SELF.changed = function( newUri ) {<br />
        return false;<br />
    };</p>
<p>    $picker.on( 'dblclick', launchOverlay );<br />
};</p>
<p>/**<br />
 * Check if a file name is that of an image.<br />
 *<br />
 * @param {string} src<br />
 * @returns {boolean}<br />
 */<br />
ImagePicker.prototype.isImage = function( src ) {<br />
    var ext = src.split( '.' ).pop();<br />
    ext = ext.toLowerCase();</p>
<p>    var extensions = [ 'jpg', 'jpeg', 'png', 'gif' ];</p>
<p>    for ( var i = 0; i < extensions.length; i++ ) {<br />
            var extension = extensions[i];</p>
<p>            if ( ext === extension ) {<br />
                return true;<br />
            }<br />
    }</p>
<p>    return false;<br />
};</p>
<p>var picker = new ImagePicker( 'Set Background Image', document.getElementById( 'image-picker' ) );<br />
</code></p>
<p>Without going in to too much detail, the object above sets up a new ThickBox image picker.  When you double-click the specified element on the page, an overlay will launch containing the media upload UI.  When you select an image, a custom change handler is called so you can do whatever you need to with the path of the newly-uploaded image.  To allow this custom handling, we have to store the original <tt>window.send_to_editor</tt> function somewhere, replace it with our own handler, then restore the original when closing the dialog.</p>
<p>Handling the <tt>FilesAdded</tt> event is similar. After the iFrame loads, we grab a reference to its internal <tt>window</tt> scope, grab the original <tt>fileQueued</tt> function so we can store it somewhere, replace it with our own handler, and restore it when the dialog closes.</p>
<h2>In Summary</h2>
<p>As one of my coworkers put it:</p>
<blockquote><p>Can't is a four-letter word.</p></blockquote>
<p>The task of hacking around a somewhat closed API seemed daunting at first.  Even now, the fact that it took me over a year to figure out this workaround is frustrating.  Luckily, the new media uploader introduced with WordPress 3.5 is a little easier to play with in terms of hooking events.  It actually <em>exports</em> the Plupload instance as part of the <tt>wp.Uploader</tt> object, so you can hook to events natively without such hacky workarounds.</p>
<p>Still, it's nice to know that, even in the absence of <a href="https://github.com/carldanley/WP-JS-Hooks" title="WP-JS-Hooks">advanced event management</a>, it's possible to hook in to WordPress when you need to manipulate stock behavior.  This flexibility is what continues to make WordPress a stellar platform for application development.</p>

        </div>
        <footer class="post-footer">
            <div class="post-share">
                <span class="post-share-title">Share:</span>
                <a target="_blank"
                    href="https://twitter.com/share?text=The+Hackiest+Hack+that+Ever+Was+Hacked&amp;url=https://ttmm.iotech/the-hackiest-hack-that-ever-was-hacked/">Twitter</a>
                <a target="_blank"
                    href="https://www.facebook.com/sharer/sharer.php?u=https://ttmm.iotech/the-hackiest-hack-that-ever-was-hacked/">Facebook</a>
            </div><!-- .share-post -->
            
            <p class="post-cats">
                <span class="post-share-title">Filed under </span>
                <a href="/categories/index.html#Technology"
                    rel="category">Technology</a>
                
            </p>
            
            
            <p class="post-tags">
                <span class="post-share-title">Tagged with </span>
                <a href="/tags/index.html#javascript"
                    rel="tag">javascript</a>
                <a href="/tags/index.html#Plupload"
                    rel="tag">Plupload</a>
                <a href="/tags/index.html#WordPress"
                    rel="tag">WordPress</a>
                
            </p>
            
        </footer>
        
    </article>
    
    <section class="read-next inner">
        <h2 class="read-next-title">Read Next</h2>
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="March 14, 2013">March 14, 2013</time>
                </div>
                <h3 class="post-title"><a href="/biz/reader-is-dead-long-live-reader/">Reader is Dead! Long Live Reader!</a>
                </h3>
            </header>
        </article>
        
        
        <article class="post">
            <header class="post-header">
                <div class="post-meta">
                    <time class="published" datetime="May 11, 2013">May 11, 2013</time>
                </div>
                <h3 class="post-title"><a href="/tech/ludicrous-speed-wordpress-caching-with-redis/">Ludicrous Speed: WordPress Caching with Redis</a></h3>
            </header>
        </article>
        
    </section><!-- .read-next -->

</main><!-- .site-main -->


                

                
                <footer id="colophon" class="site-footer">
    <p class="site-info inner">
        <a href="#">Things that Matter Most</a> &copy; 2021. Royce theme by
        <a target="_blank" href="https://justgoodthemes.com/">JustGoodThemes</a>.
        <br />
        Powered by <a target="_blank" href="https://jekyllrb.com/">Jekyll</a>.
    </p>
    <a id="back-to-top" class="back-to-top" href="#page">
        <span class="icon-arrow-up" aria-hidden="true"></span>
        <span class="screen-reader-text">Back to top</span>
    </a>
</footer><!-- .site-footer -->
            </div><!-- .inner-wide -->
        </div><!-- .site-content -->
    </div><!-- .site -->

    
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4156949-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-4156949-6', { 'anonymize_ip': true });
  </script>

    <!-- Javascript Assets -->
    <script src="/assets/js/jquery-3.3.1.min.js"></script>
    <script src="/assets/js/plugins.js"></script>
    <script src="/assets/js/custom.js"></script>

</body>

</html>